---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---

## Introduction
 The objective of this assignment is to analyse data generated by a personal activity monitoring device to answer identified questions and report on these in an R markdown document. 

Sections of the report answering sub-questions of the assignment are highglighted in **bold** typeface.

The following global options have been used in the report
``` {r message=FALSE}
knitr::opts_chunk$set(fig.width=12, 
                      fig.height=8, 
                      fig.path='figures/',
                      echo=TRUE, 
                      warning=FALSE, 
                      message=FALSE)

library(ggplot2)
library(dplyr)
options(scipen = 999)
```

## Loading and preprocessing the data

**Code needed to load the data and processing the data into a format suitable for analysis is as follows.**
``` {r}
activity <- read.csv(file="activity.csv", 
                     colClasses=c("steps"="integer", "date"="Date", "interval"="integer"))
```


## What is mean total number of steps taken per day?
Mean of the total number of steps per each day has been determined as follows.

Firstly, we need to **calculate the total number of steps taken per day**.

```{r}
steps_daily_total <- 
        activity %>% 
        group_by(date) %>% 
        summarise (steps= sum(steps))
head(steps_daily_total)
```

Secondly, we **make a histogram of the total number of steps taken each day**

```{r, plot1_total_daily_steps_original}
ggplot(steps_daily_total, aes(x=steps)) + 
        geom_histogram(bins=10, fill="grey50", color="white") + 
        labs (x="Daily Steps", y="Frequency", title = "Activity Frequency")
```

Thirdly, we **calculate and report the mean and median of the total number of steps taken per day**

``` {r}
mean_daily_steps <- round(mean(steps_daily_total$steps, na.rm=TRUE))
median_daily_steps <- round(median(steps_daily_total$steps, na.rm=TRUE))
```

* Mean : `r mean_daily_steps`
* Median : `r median_daily_steps`

## What is the average daily activity pattern?

As a preparatory step, a data set steps_activity_avg has been created by grouping the activity data by interval and summarising average number of steps within each interval across all days.

```{r}
steps_interval_avg <- 
        activity %>% 
        group_by(interval) %>% 
        summarise (steps=mean(steps, na.rm=TRUE)) %>%
        ungroup() %>%
        arrange(interval)
head(steps_interval_avg)
```

This data was then used to **Make a time series plot of the 5-minute interval and the average number of steps taken, averaged across all days**
```{r, plot2_avg_steps_by_interval}
ggplot(steps_interval_avg, aes(interval, steps)) + 
        geom_line() + 
        labs (x="Interval", y="Number of steps", title = "Average Number Of Steps By Interval")
```

The data was also used to answer the question: **"Which 5-minute interval that, on average, contains the maximum number of steps?"**

```{r}
peak_interval <- as.integer(steps_interval_avg [which.max(steps_interval_avg$steps),"interval"])

peak_steps <- as.integer(steps_interval_avg [which.max(steps_interval_avg$steps),"steps"])

peak_interval_time <- sprintf("%.02d:%.02d", peak_interval %/% 60, round(peak_interval %% 60))
```

We can see the details of this interval below:

* Interval: `r peak_interval` (corresponding to `r peak_interval_time`h) 
* Steps: `r peak_steps`

## Imputing missing values

Firstly, we **calculate total number of missing values in the dataset (i.e. the total number of rows with NAs).**

``` {r}
missing_values_rows <- sapply(activity, function(x) sum(is.na(x)))
missing_values_rows
```

We then need to **Devise a strategy for filling in all of the missing values in the dataset.**
This strategy involves using the mean number of steps in 5 minutes interval across all days (from steps_interval_avg data frame).

Subsequently, we **use this strategy to create a new dataset that is equal to the original dataset but with the missing data filled in.**

``` {r}

activity_imputed <- # order activity data in the same way as steps_interval_avg
        activity %>% arrange(date, interval) 
activity_imputed$steps <- # fill in the missing numbers from steps_interval_avg
        coalesce(activity$steps, 
                 rep(steps_interval_avg$steps, 
                 times=length(activity$steps)/length(steps_interval_avg$steps)))
head(activity_imputed)
```

As a preparatory step for subsequent activities, we then use the imputed activity data to calculate the total number of steps total number of steps taken in each 5 minute interval across all days in the data set:
```{r}
steps_imputed_daily_total <- # summarise the imputed activity data set
        activity_imputed %>% group_by(date) %>% summarise (steps= sum(steps))
head(steps_imputed_daily_total)
```

Subsequently, we use this data to **make a histogram of the total number of steps taken each day**

```{r, plot3_total_daily_steps_imputed}
ggplot(steps_imputed_daily_total, aes(x=steps)) + 
        geom_histogram(bins=10, fill="grey50", color="white") + 
        labs (x="Daily Steps  (incl. Imputed Values", y="Frequency", title = "Activity Frequency")

```

We also use this data to understand the impact of imputation on overall characteristics of the data set:

**Calculate and report the mean and median total number of steps taken per day.**

```{r}
mean_daily_steps_imputed <- round(mean(steps_imputed_daily_total$steps, na.rm=TRUE))
median_daily_steps_imputed <- round(median(steps_imputed_daily_total$steps, na.rm=TRUE))
```

```{r}
mean_daily_steps_imputed
median_daily_steps_imputed
```

**Do these values differ from the estimates from the first part of the assignment?**
```{r}
mean_daily_steps_imputed - mean_daily_steps
median_daily_steps_imputed - median_daily_steps
```

Analysis below shows **what is the impact of imputing missing data on the estimates of the total daily number of steps?**, by showing the magnitude of difference (steps_dif) between the number of steps in the original data set (steps_original) and number of steps in the data set with imputations (steps_imputed).
```{r}
steps_daily_total_dif <- 
        steps_daily_total %>%               # copy the steps_daily_total data set
        mutate(steps_original0=steps) %>%   # create a copy of the steps column called steps_original0
        rename(steps_original=steps) %>%    # rename steps column to steps_original
        tidyr::replace_na(list(steps_original0=0)) %>% # replace NAs in steps_original0 with zeros
        mutate (steps_imputed = steps_imputed_daily_total$steps, # create a copy of the column steps_imputed
                steps_dif = steps_imputed-steps_original0) %>% #calculated difference between the two columns
        filter(steps_dif!=0) %>%             # filter out columns with zero difference
        select (-steps_original0)            # remove steps_original0
steps_daily_total_dif
```

## Are there differences in activity patterns between weekdays and weekends?

We use the activity data set to  **create a new factor variable in the dataset with two levels – “weekday” and “weekend” indicating whether a given date is a weekday or weekend day.**
```{r}
activity_imputed$daytype <- factor(
        (weekdays(activity_imputed$date) %in% c("Saturday", "Sunday")), 
        labels=c("Weekday", "Weekend"))
head(activity_imputed)
```

As a preparation for the next step, we then calculate average number of steps taken, averaged across all days, separate for weekday and weekend days.

``` {r}
steps_imputed_interval_avg <- 
        activity_imputed %>% 
        group_by(daytype, interval) %>% 
        summarise (steps= round(mean(steps)))
head(steps_imputed_interval_avg)
```

Subsequently we **make a panel plot comparing the average number of steps taken per 5-minute interval across weekdays and weekends**.

```{r, plot4_avg_steps_byinterval_bydaytype}

ggplot(steps_imputed_interval_avg, aes(interval, steps)) + geom_line()  + facet_wrap(vars(daytype), nrow=2) + labs (x="Interval", y="Number of steps")
```